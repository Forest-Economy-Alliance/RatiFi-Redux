const CACHE_VERSION=`app-static-${new Date().toISOString()}`;self.addEventListener("install",e=>{e.waitUntil(caches.open(CACHE_VERSION).then(e=>e.addAll(["/","/index.html","/offline.html"]))),self.skipWaiting()}),self.addEventListener("activate",e=>{e.waitUntil(caches.keys().then(e=>Promise.all(e.map(e=>{if(e!==CACHE_VERSION)return console.log("Deleting old cache:",e),caches.delete(e)})))),self.clients.claim()}),self.addEventListener("fetch",e=>{e.request.url.startsWith("http")&&("navigate"===e.request.mode?e.respondWith(fetch(e.request).then(e=>caches.open(CACHE_VERSION).then(t=>(t.put("/index.html",e.clone()),e))).catch(()=>caches.match("/index.html").then(e=>e||caches.match("/offline.html")))):e.respondWith(fetch(e.request).then(t=>caches.open(CACHE_VERSION).then(n=>(n.put(e.request,t.clone()),t))).catch(()=>caches.match(e.request))))}),self.addEventListener("sync",e=>{"sync-claim-docs"===e.tag&&e.waitUntil(syncPendingClaims())});const syncPendingClaims=async()=>{console.log("Syncing pending claims...");try{let e=await openDB(),t=e.transaction("claim-images","readonly"),n=t.objectStore("claim-images"),a=await new Promise((e,t)=>{let a=n.getAll();a.onsuccess=()=>e(a.result),a.onerror=e=>t(e.target.error)});if(Array.isArray(a)&&a.length>0)for(let i of a)try{console.log("Uploading image:",i);let r={fileName:"DUMMY_NAME",base64Data:await blobToBase64(i.blob),userId:i?.userId,isPdf:!1},o=await fetch("https://4kmtkz4pcv.us-east-1.awsapprunner.com/get-gcp-url",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)});if(o.ok){let s=await o.json(),l=s.response.Location;console.log("Image uploaded successfully:",l);let c=e.transaction("claim-images","readwrite");c.objectStore("claim-images").delete(i.id),console.log("Image removed from IndexedDB:",i.id)}else console.error("Failed to upload image:",o.statusText)}catch(d){console.error("Error uploading image:",d)}else console.log("No images to sync")}catch(m){console.error("Error syncing pending claims:",m)}};function blobToBase64(e){return new Promise((t,n)=>{let a=new FileReader;a.onloadend=()=>t(a.result.split(",")[1]),a.onerror=n,a.readAsDataURL(e)})}function openDB(){return new Promise((e,t)=>{let n=indexedDB.open("ClaimSyncDB",1);n.onupgradeneeded=e=>{let t=e.target.result;t.objectStoreNames.contains("claim-images")||t.createObjectStore("claim-images",{keyPath:"id",autoIncrement:!0})},n.onsuccess=()=>e(n.result),n.onerror=e=>t(e.target.error)})}